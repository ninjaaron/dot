#!/bin/bash

# file browsing with dmenu

source $HOME/.dmenurc
DMENU="eval ${DMENU-dmenu}"

# this is actually the last function called. Customize behavior by extension
# here.

open() {
  case "$sel" in
    *.mkv*|*.mov*|*.avi*|*.flv*|*.ogv*|*.mpeg*|*.mp4*|*.m4v*|*.webm*|*.mp3|*.ogg|*.flac|*.wmv* )
      mpv "$sel" &
      ;;
    *.pdf|*.ps|*.djvu )
      zathura "$sel" &
      ;;
    *.jpg|*.gif|*.png )
      geeqie "$sel" &
      ;;
    *.xfc )
      gimp "$sel" &
      ;;
    *.odt|*.odp|*.odg|*.ods|*.doc )
      libreoffice "$sel" &
      ;;
    *.html|*.htm )
      firefox "$sel" &
      ;;
    *) # with undefined extensions, open vim. If the directory isn't
       # somewhere in $HOME, ask for sudo.
      if  [[ ${PWD/*$USER*/$USER} != $USER ]] &&
      [[ $(echo -e "y\nn"|$DMENU -p "sudo?") = y ]] ; then
        urxvtc -e sh -c "sudo vim -u $HOME/.vimrc '$PWD/$sel'"
        exit
      else
        urxvtc -e sh -c "vim '$PWD/$sel'"
      fi
  esac
}


browse() {
  while [ -d "$sel" ]; do
    cd "$sel"
    case $show in
      advanced)
        sel=$(
          (ls -a
           echo ..
           printf '(basic)'
          ) |$DMENU -p "$PWD:" -l 60)
        ;;
      *)
        sel=$(
          (ls
           echo ..
           echo '(advanced)'
          ) |$DMENU -p "$PWD:")
        ;;
    esac
  done

  case $sel in
    "(advanced)")
      show=advanced
      sel=$PWD
      browse
      ;;
    "(basic)")
      show=basic
      sel=$PWD
      browse
      ;;
    "")
      exit 0
      ;;
    *)
      open&
  esac
}

sel=$PWD
browse

exit
