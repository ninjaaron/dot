#!/usr/bin/env python3
import sys, os, subprocess, shlex

argv = sys.argv[1:]
try:
    if argv[0] == '-a':
        mode = 'a'
        argv = argv[1:]
    else:
        mode = 'w'
    with open('.playlist', mode) as playlist:
        if argv:
            playlist.writelines([file+'\n' for file in argv])
except IndexError:
    pass

while True:
    with open('.playlist') as playlist:
        cmd = playlist.readline()
        lines = playlist.readlines()

    if not lines:
        os.remove('.playlist')
        break

    out = subprocess.run(
            shlex.split(cmd) + [lines[0].rstrip()],
            universal_newlines=True,
            stdout=subprocess.PIPE
            ).stdout.splitlines()
    if cmd.startswith('mpv') and 'Quit' in out[-1]:
        break

    with open('.playlist', 'w') as playlist:
        playlist.write(cmd)
        playlist.writelines(lines[1:])
