#!/usr/bin/env python3
import argparse
import shlex
import subprocess
import libaaron
from libaaron import aio
import transmission as tr


def sftp_dl(path, host):
    args = ['sftp', '-ar', host + ':/' + shlex.quote(path[1:]), '.']
    return subprocess.run(args).returncode


async def main():
    libaaron.quietinterrupt('download interupted')
    ap = argparse.ArgumentParser()
    add = ap.add_argument
    add('targets', nargs='+')
    add('-s', help='server address')
    add('-r', action='store_true', help='delete torrent after downloading')

    args = ap.parse_args()
    async with tr.Torrents() as torrents:
        try:
            await torrents(*map(int, args.targets))
        except ValueError:
            await torrents.by_pattern(args.targets[0])
        print('queued:')
        print(*('  ' + t.name for t in torrents), sep='\n')

        async for torrent in torrents.completed():
            retcode = sftp_dl(await torrent.path, args.s)
            if args.r and not retcode:
                await torrent.remove(delete=True)
                print('removed:', torrent.name)


if __name__ == '__main__':
    aio.run(main())
