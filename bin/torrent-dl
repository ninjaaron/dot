#!/usr/bin/env python3

from collections import namedtuple
import re
import easyproc as ep
import click

Torrent = namedtuple('Torrent',
                     'id, perc, have, eta, up, down, ratio, status, name')
gap = re.compile('[ ]{2,}')


@click.command()
@click.option('-s',prompt='server', help='server address')
@click.option('-r', is_flag=True, help='delete torrent after downloading')
@click.option('-p', is_flag=True, help='print matches and exit')
@click.option('--ext', type=str, help='grab only this file extention')
@click.argument('targets', type=str, nargs=-1)
def main(s, r, p, ext, targets):
    srv = s
    command = 'ssh ' + srv + ' transmission-remote -l'
    torrents = (Torrent(*gap.split(t.strip())) for t in ep.grab(command)[1:-1])
    try:
        int(targets[0])
    except ValueError:
        if targets[1]:
            pat = re.compile('(?{})'.format(targets[1])+targets[0])
        else:
            pat = re.compile(targets[0])
        matches = (t for t in torrents
                   if pat.search(t.name) and t.perc == '100%')
    else:
        matches = (t for t in torrents if t.id in targets)
    if p:
        print('\n'.join(t.name for t in matches))
        exit()
    for torrent in matches:
        filename = srv + ":dls/'" + torrent.name + "'"
        if ext:
            filename += '/*' + ext
        ep.run(['sftp', '-r', filename, '.'], check=True)
        if r:
            ep.run(['ssh', srv, 'transmission-remote',
                    '-t', torrent.id, '--remove-and-delete'])


if __name__ == '__main__':
    main()
