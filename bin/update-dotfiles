#!/bin/sh

message() {
  echo "$@" 1>&2
}
fail () {
  code="$1"
  shift
  message "$@"
  exit "$code"
}

get_branch() {
  git branch | awk '$1 == "*" { print $2 }' 
}


cd "$DOT" || fail "$?" "dotfile folder does not exist"
branch="$(get_branch)"
if [ -z "$branch" ]; then
  exit 1
fi
message "================ git ================"
message "== committing =="
git commit -am "updating dotfiles"

if [ "$branch" != "master" ]; then
  git checkout master
fi

message "== pulling changes =="
git pull --recurse-submodules origin master &&
  message "== pushing changes ==" &&
  git push origin master ||
    message 'there were problems'

if [ "$branch" != "master" ]; then
  message "== merging into $branch ==" &&
  git checkout "$branch"
  git merge master &&
    git push origin "$branch" ||
      message "there were problems"
fi
